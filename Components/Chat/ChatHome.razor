@using COMP4952_Sockim.Services
@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Models
@using Microsoft.AspNetCore.Identity
@using System.Security.Claims
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Options
@using System.Numerics

@rendermode InteractiveServer
@inject NavigationManager NavManager
@inject UserManager<ChatUser> UserManager
@inject ChatService ChatService

<div class="app-layout">
    <ChatErrors ChatHubConnection="@_chatHubConnection" Errors="@_errors"></ChatErrors>
    <div class="main-content">
        <div class="main-content-header">
            <ChatInvitations ChatHubConnection="@_chatHubConnection" Invitations="@_invitations" User="@_user" />
        </div>
        <hr />
        @if(!_chatOpen)
        {
            <div class="chat-list-header">
                <button class="btn-regular" @onclick="OnAddChat">Create Chat</button>
            </div>
            @if(_user is not null && _chatHubConnection is not null && _showCreateChat)
            {
                <ChatCreateForm ChatHubConnection=_chatHubConnection User=_user OnClose="CloseAddChat" />
            }
            <ChatList   ChatOpened="@OpenChat"
                        ChatHubConnection="@_chatHubConnection"
                        Chats="@_chats"
                        User="@_user" />
        }
        else
        {
            <ChatForm   MessageHubConnection="@_messageHubConnection"
                        ChatHubConnection="@_chatHubConnection"
                        CloseChat="@CloseChat"
                        ChatDto="@_chat"
                        Messages="@_messages"
                        User="@_user" />
        }
    </div>
</div>

@code {

    [CascadingParameter]
    private Task<AuthenticationState>? _authState { get; set; }
    private ElementReference _chatForm;
    private ClaimsPrincipal _userClaim = null!;
    private ChatUser _user = null!;
    private ChatDto _chat = null!;

    private List<ChatDto> _chats = [];
    private List<ChatInvitationDto> _invitations = [];
    private List<ChatMessageDto> _messages = [];
    private List<SockimError> _errors = [];

    private HubConnection? _chatHubConnection;
    private HubConnection? _invitationHubConnection;
    private HubConnection? _messageHubConnection;

    private bool _showCreateChat = false;
    private bool _chatOpen = false;
    private bool IsChatConnected => _chatHubConnection?.State == HubConnectionState.Connected;
    private bool IsInvitationConnected => _invitationHubConnection?.State == HubConnectionState.Connected;
    private bool IsMessageConnected => _messageHubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        if (_authState is not null)
        {
            var authState = await _authState;
            _userClaim = authState.User;

            if (_userClaim.Identity!.IsAuthenticated)
            {
                _user = (await UserManager.GetUserAsync(_userClaim))!;
            }

            _chatHubConnection = new HubConnectionBuilder()
                .WithUrl(NavManager.ToAbsoluteUri("/chathub"))
                .WithAutomaticReconnect()
                .Build();

            _chatHubConnection.On<ChatDto>("ChatCreated", (ChatDto newChat) =>
            {
                _chats.Add(newChat);
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatDto[]>("RetrievedChats", (ChatDto[] retrievedChats) =>
            {
                _chats = retrievedChats.ToList();
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatDto>("RemovedFromChat", (ChatDto chat) => {
                if (_chatOpen)
                    InvokeAsync(CloseChat);
                _chats.Remove(chat);
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatDto>("ChatUpdated", (ChatDto chat) => {
                int index = _chats.IndexOf(chat);
                _chats[index] = chat;
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatInvitationDto>("IncomingInvitation", (ChatInvitationDto) => {
                _invitations.Add(ChatInvitationDto);
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatDto>("InvitationAccepted", (ChatDto newChat) => {
                _chats.Add(newChat);
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<ChatInvitationDto[]>("RetrievedInvitations", (ChatInvitationDto[] invitations) =>
            {
                _invitations = invitations.ToList();
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<object>("InvitationRejected", (object data) =>
            {
                // Invitation was rejected - it's already removed server-side
                // Invitation was already removed from UI in ChatInvitations component
                InvokeAsync(StateHasChanged);
            });

            _chatHubConnection.On<SockimError>("Error", (SockimError error) => {
                _errors.Add(error);
                InvokeAsync(StateHasChanged);
            });

            _messageHubConnection = new HubConnectionBuilder()
                .WithUrl(NavManager.ToAbsoluteUri("/messagehub"))
                .WithAutomaticReconnect()
                .Build();

            _messageHubConnection.On<SockimError>("Error", (SockimError error) => {
                Console.WriteLine($"CLIENT ERROR RECEIVED: {error.Message}");
            });

            if (_chatHubConnection.State == HubConnectionState.Disconnected)
                await _chatHubConnection.StartAsync();
            if (_messageHubConnection.State == HubConnectionState.Disconnected)
                await _messageHubConnection.StartAsync();

            await _chatHubConnection.SendAsync("AddChatUser", _user.Id);
            await _chatHubConnection.SendAsync("RetrieveChats", _user.Id);
            await _chatHubConnection.SendAsync("RetrieveInvitations", _user.Id);
        }
    }

    private void OnAddChat()
    {
        _showCreateChat = true;
    }

    private void CloseAddChat()
    {
        _showCreateChat = false;
        StateHasChanged();
    }

    private void OpenChat(ChatDto chat)
    {
        _chat = chat;
        _chatOpen = true;
    }

    private void CloseChat()
    {
        _chatOpen = false;
        StateHasChanged();
    }
}
