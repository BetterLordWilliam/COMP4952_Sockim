@using COMP4952_Sockim.Components.Pages
@using COMP4952_Sockim.Hubs
@using COMP4952_Sockim.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.ComponentModel.DataAnnotations
@using Microsoft.Build.Framework
@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Models
@using System.Security.Claims

@rendermode InteractiveServer
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject UserManager<ChatUser> UserManager
@inject NavigationManager NavManager
@inject ChatUserService ChatUserService
@inject ChatService ChatService

<button type="button" class="btn-remove" @onclick="CloseChat">Close</button>
<button type="button" class="btn-remove" @onclick="@OpenChatOptions">Chat Options</button>
@if(_showChatOptions) {
    <div class="modal">
        <div class="modal-content members-panel">
            <h3>Members</h3>
            @if (_chatMembers != null && _chatMembers.Count > 0)
            {
                <ul class="members-list">
                    @foreach (var member in _chatMembers)
                    {
                        <li class="member-item">
                            <span class="member-email">@member.Email</span>
                            @if (User?.Id == ChatDto.ChatOwnerId && member.Id != ChatDto.ChatOwnerId)
                            {
                                <button type="button" class="btn-remove" @onclick="() => RemoveMember(member.Id)" title="Remove member">Remove</button>
                            }
                        </li>
                    }
                </ul>
            }
            <hr />
            <div class="invite-section">
                <h4>Invite Member</h4>
                <input type="email" @bind="_inviteEmail" placeholder="Enter email address" />
                <button type="button" class="invite-btn" @onclick="InviteMember">Invite</button>
                <button type="button" class="btn-remove" @onclick="() => RemoveMember(User?.Id ?? 0)" disabled="@(User == null || _isOwner)">Leave</button>
                @if (!string.IsNullOrEmpty(_inviteStatus))
                {
                    <p class="invite-status">@_inviteStatus</p>
                }
            </div>
            <button class="btn-remove" type="button" @onclick="@CloseChatOptions">Close</button>
        </div>
    </div>
}
<div class="main-content chat-main-content">
    <section class="section chat-section">
        <div class="chat-header">
            @if(_editChatName) {
                <h2>
                    <input type="text" @bind-value="@_updatedChatName" />
                </h2>
                <div class="display:flex;flex-direction:row;">
                    <button class="btn-remove" type="button" @onclick="SaveRenameChat">Save</button>
                    <button class="btn-remove" type="button" @onclick="CancelRenameChat">Cancel</button>
                </div>
            } else {
                <h2>@ChatDto.ChatName</h2>
            }
            <button class="btn-remove" type="button" @onclick="@RenameChat">Rename</button>
            @if (User?.Id == ChatDto.ChatOwnerId)
            {
                <div class="owner-controls">
                    <p><em>You are the chat owner</em></p>
                </div>
            }
        </div>
        <div class="chat-content">
            <div class="message-list-wrapper" @ref="_messageListWrapper">
                <ul class="message-list">
                    @if (User is not null)
                    {
                        @foreach (ChatMessageDto message in _messages)
                        {
                            <li>
                                <span class="message-meta"><b>@message.SenderEmail</b>, <b>@message.MessageDateTime</b></span>
                                @if (_editMessage && _editMessageId == message.Id) {
                                    <input type="text" @bind-value="@_updatedMessage" />
                                    <div class="display:flex;flex-direction:row;">
                                        <button class="btn-remove" type="button" @onclick="() => SaveMessageEdit(message, _updatedMessage)">Save</button>
                                        <button class="btn-remove" type="cancel" @onclick="() => CancelMessageEdit(message)">Cancel</button>
                                    </div>
                                } else {
                                    <p class="message-text">@message.MessageContent</p>
                                }
                            </li>
                            @if(message.ChatUserId == User.Id) {
                                <button class="btn-remove" type="button" disabled="@_editMessage"
                                        @onclick="() => EditMesssage(message)" >
                                    Edit
                                </button>
                            }
                        }
                    }
                </ul>
            </div>
            <div class="input-controls">
                <div class="form-group">
                    <label for="message-input">Message:</label>
                    <input id="message-input" @bind="_message" class="message-input" />
                </div>
                <button class="send-btn" @onclick="Send">Send</button>
            </div>
        </div>
    </section>
</div>

@code {
    [Parameter]
    public ChatDto ChatDto { get; set; } = null!;
    [Parameter]
    public ChatUser User { get; set; } = null!;
    [Parameter]
    public HubConnection MessageHubConnection { get; set; } = null!;
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }
    [Parameter]
    public List<ChatMessageDto>? Messages { get; set; }
    [Parameter]
    public bool Disabled { get; set; } = true;
    [Parameter]
    public EventCallback CloseChat { get; set; }

    private ElementReference _messageListWrapper;
    private List<ChatMessageDto> _messages = [];
    private List<ChatUserDto> _chatMembers = [];
    private string _message = string.Empty;
    private string _updatedMessage = string.Empty;
    private string _updatedChatName = string.Empty;
    private string _inviteEmail = string.Empty;
    private string _inviteStatus = string.Empty;
    private int _editMessageId = -1;
    private bool _isOwner => User.Id == ChatDto.ChatOwnerId;
    private bool _showChatOptions = false;
    private bool _editMessage = false;
    private bool _editChatName = false;

    protected override async Task OnInitializedAsync()
    {
        if (ChatHubConnection is not null)
        {
            ChatHubConnection.On<ChatUserDto>("MemberJoined", (ChatUserDto user) => {
                _chatMembers.Add(user);
                InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<ChatDto, ChatUserDto>("MemberRemoved", (ChatDto chat, ChatUserDto chatUser) => {
                _chatMembers.Remove(chatUser);
                InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<ChatUserDto[]>("RetrievedUsers", (ChatUserDto[] users) => {
                _chatMembers = users.ToList();
                InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<ChatDto>("ChatUpdated", (ChatDto chat) => {
                ChatDto = chat;
                InvokeAsync(StateHasChanged);
            });

            await ChatHubConnection.SendAsync("ConnectToChatGroup", ChatDto.Id);
            await ChatHubConnection.SendAsync("GetChatMembers", ChatDto.Id);
        }

        if (MessageHubConnection is not null)
        {
            @* // User comes online
            MessageHubConnection.On<ChatUserDto>("UserJoined", (ChatUserDto user) => {
            });

            // User goes offline
            MessageHubConnection.On<ChatUserDto>("UserLeft", (ChatUserDto user) => {
            });

            MessageHubConnection.On<ChatUserDto>("MemberRemoved", (ChatUserDto user) => {
            }); *@

            MessageHubConnection.On<ChatMessageDto>("MessageUpdated", (ChatMessageDto message) =>
            {
                int index = _messages.IndexOf(message);
                _messages[index] = message;
                InvokeAsync(StateHasChanged);
            });

            MessageHubConnection.On<ChatMessageDto>("ReceiveMessage", (ChatMessageDto message) =>
            {
                _messages.Add(message);
                InvokeAsync(StateHasChanged);
            });

            MessageHubConnection.On<ChatMessageDto[]>("RetrievedMessages", (ChatMessageDto[] messages) =>
            {
                _messages = messages.ToList();
                InvokeAsync(StateHasChanged);
            });

            await MessageHubConnection.SendAsync("JoinChat", ChatDto.Id, User.Id);
            await MessageHubConnection.SendAsync("GetChatHistory", ChatDto.Id);

        }
    }

    private void OpenChatOptions()
    {
        _showChatOptions = true;
    }

    private void CloseChatOptions()
    {
        _showChatOptions = false;
    }

    private void RenameChat()
    {
        _editChatName = true;
        _updatedChatName = ChatDto.ChatName;

        InvokeAsync(StateHasChanged);
    }

    private async void SaveRenameChat()
    {
        _editChatName = false;

        if (ChatHubConnection is null)
            return;

        ChatDto.ChatName = _updatedChatName;

        await ChatHubConnection.SendAsync("RenameChat", ChatDto);
        await InvokeAsync(StateHasChanged);
    }

    private void CancelRenameChat()
    {
        _editChatName = false;

        InvokeAsync(StateHasChanged);
    }

    private void EditMesssage(ChatMessageDto message)
    {
        // switch the span into an input
        // give the span the same content
        // when the message is finished editing, send to db and update

        _editMessage = true;
        _updatedMessage = message.MessageContent;
        _editMessageId = message.Id;

        Console.WriteLine(message.Id);

        InvokeAsync(StateHasChanged);
    }

    private void CancelMessageEdit(ChatMessageDto message)
    {
        _editMessage = false;
        _editMessageId = -1;

        InvokeAsync(StateHasChanged);
    }

    private async void SaveMessageEdit(ChatMessageDto message, string _updatedMessage)
    {
        _editMessage = false;
        _editMessageId = -1;

        // Save changes to the database if the message content is actually different.
        Console.WriteLine($"Edited: {message.MessageContent}"); 

        message.MessageContent = _updatedMessage;

        await MessageHubConnection.SendAsync("EditMessage", message);
        await InvokeAsync(StateHasChanged);
    }

    private async Task ScrollToBottom()
    {
        if (_messageListWrapper.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("scrollToElementBottom", _messageListWrapper);
        }
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(_message) || User == null)
            return;

        ChatMessageDto newMessage = new()
        {
            ChatId = ChatDto.Id,
            ChatUserId = User.Id,
            SenderEmail = User.Email ?? string.Empty,
            MessageContent = _message,
            MessageDateTime = DateTime.UtcNow
        };

        Console.WriteLine($"{newMessage.SenderEmail}");

        try
        {
            if (MessageHubConnection is not null)
            {
                await MessageHubConnection.SendAsync("SendMessage", ChatDto.Id, newMessage);
                await ScrollToBottom();
            }
            _message = string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
    }

    /// <summary>
    /// Invite a user to the chat by email.
    /// Calls ChatHub to create the invitation.
    /// </summary>
    private async Task InviteMember()
    {
        if (string.IsNullOrWhiteSpace(_inviteEmail) || ChatHubConnection is null)
        {
            _inviteStatus = "Please enter a valid email address";
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("InviteUserToChat", ChatDto.Id, User.Id, _inviteEmail);
        }
        catch (Exception ex)
        {
            _inviteStatus = $"Error: {ex.Message}";
            Console.WriteLine($"Error inviting member: {ex.Message}");
        }
    }

    /// <summary>
    /// Remove a member from the chat.
    /// Only the chat owner can remove members.
    /// Calls ChatHub to remove the user.
    /// </summary>
    private async Task RemoveMember(int memberId)
    {
        if (ChatHubConnection is null)
        {
            Console.WriteLine("ChatHub connection not available");
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("RemoveUserFromChat", ChatDto.Id, User.Id, memberId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing member: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (ChatHubConnection is not null)
        {
            await ChatHubConnection.SendAsync("DisconnectToChatGroup", ChatDto.Id);
        }
        if (MessageHubConnection is not null)
        {
            await MessageHubConnection.SendAsync("LeaveChat", ChatDto.Id, User.Id);
        }
    }
}
