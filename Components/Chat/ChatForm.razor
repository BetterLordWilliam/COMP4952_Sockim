@using COMP4952_Sockim.Hubs
@using COMP4952_Sockim.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.ComponentModel.DataAnnotations
@using Microsoft.Build.Framework
@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Models
@using Microsoft.DotNet.Scaffolding.Shared.Messaging
@using System.Security.Claims

@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject UserManager<ChatUser> UserManager
@inject NavigationManager NavManager
@inject AuthenticationStateProvider ASP
@inject MessagesService MessagesService

<div class="chat-container">
    <div class="message-list-wrapper" @ref="_messageListWrapper">
        <ul class="message-list">
            @foreach (ChatMessageDto message in _messages)
            {
                <li>
                    <span><b>@message.SenderEmail</b>, <b>@message.MessageDateTime</b></span>
                    <p>@message.MessageContent</p>
                </li>
            }
        </ul>
    </div>
    <div class="input-controls">
        <div class="form-group">
            <br />
            <label>
                Message: <input @bind="_message" />
            </label>
        </div>
        <button @onclick="Send">Send</button>
    </div>
</div>

@code {
    [Parameter]
    public ChatDto ChatDto { get; set; } = null!;
    [Parameter]
    public ChatUser User { get; set; } = null!;
    [Parameter]
    public HubConnection MessageHubConnection { get; set; } = null!;
    [Parameter]
    public bool Disabled { get; set; } = true;

    private ElementReference _messageListWrapper;
    private List<ChatMessageDto> _messages = [];
    private string _message = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (MessageHubConnection is not null)
        {
            MessageHubConnection.On<object>("UserJoined", async (object info) => {
                Console.WriteLine($"User join info {info}");
            });

            MessageHubConnection.On<object>("UserLeft", async (object info) => {
                Console.WriteLine($"User left info {info}");
            });

            MessageHubConnection.On<ChatMessageDto>("ReceiveMessage", (ChatMessageDto message) =>
            {
                _messages.Add(message);
                InvokeAsync(StateHasChanged);
            });

            MessageHubConnection.On<ChatMessageDto[]>("RetrievedChats", (ChatMessageDto[] messages) =>
            {
                _messages = messages.ToList();
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private async Task ScrollToBottom()
    {
        if (_messageListWrapper.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("scrollToElementBottom", _messageListWrapper);
        }
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(_message) || User == null)
            return;

        ChatMessageDto newMessage = new()
        {
            ChatId = ChatDto.Id,
            ChatUserId = User.Id,
            SenderEmail = User.Email ?? string.Empty,
            MessageContent = _message,
            MessageDateTime = DateTime.UtcNow
        };

        Console.WriteLine($"{newMessage.SenderEmail}");

        try
        {
            if (MessageHubConnection is not null)
            {
                await MessageHubConnection.SendAsync("SendMessage", ChatDto.Id, newMessage);
                await ScrollToBottom();
            }
            _message = string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
    }
}
