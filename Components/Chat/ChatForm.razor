@using COMP4952_Sockim.Hubs
@using COMP4952_Sockim.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.ComponentModel.DataAnnotations
@using Microsoft.Build.Framework
@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Models
@using System.Security.Claims

@rendermode InteractiveServer
@implements IAsyncDisposable
@inject IJSRuntime JSRuntime
@inject UserManager<ChatUser> UserManager
@inject NavigationManager NavManager
@inject ChatUserService ChatUserService
@inject ChatService ChatService

<div class="chat-container">
    <div class="chat-header">
        <h2>@ChatDto.ChatName</h2>
        @if (User?.Id == ChatDto.ChatOwnerId)
        {
            <div class="owner-controls">
                <p><em>You are the chat owner</em></p>
            </div>
        }
    </div>

    <div class="chat-content">
        <div class="message-list-wrapper" @ref="_messageListWrapper">
            <ul class="message-list">
                @if (Messages is not null)
                {
                    @foreach (ChatMessageDto message in _messages)
                    {
                        <li>
                            <span><b>@message.SenderEmail</b>, <b>@message.MessageDateTime</b></span>
                            <p>@message.MessageContent</p>
                        </li>
                    }
                }
            </ul>
        </div>

        <div class="input-controls">
            <div class="form-group">
                <label>
                    Message: <input @bind="_message" />
                </label>
            </div>
            <button @onclick="Send">Send</button>
        </div>
    </div>

    <div class="members-panel">
        <h3>Members</h3>
        @if (_chatMembers != null && _chatMembers.Count > 0)
        {
            <ul class="members-list">
                @foreach (var member in _chatMembers)
                {
                    <li>
                        <span>@member.Email</span>
                        @if (User?.Id == ChatDto.ChatOwnerId && member.Id != ChatDto.ChatOwnerId)
                        {
                            <button type="button" class="btn-remove" @onclick="() => RemoveMember(member.Id)" title="Remove member">X</button>
                        }
                    </li>
                }
            </ul>
        }
        <br />
        <button type="button" @onclick="() => RemoveMember(User.Id)" disabled="@_isOwner">Leave</button>

        <div class="invite-section">
            <h4>Invite Member</h4>
            <input type="email" @bind="_inviteEmail" placeholder="Enter email address" />
            <button @onclick="InviteMember">Invite</button>
            @if (!string.IsNullOrEmpty(_inviteStatus))
            {
                <p class="invite-status">@_inviteStatus</p>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public ChatDto ChatDto { get; set; } = null!;
    [Parameter]
    public ChatUser User { get; set; } = null!;
    [Parameter]
    public HubConnection MessageHubConnection { get; set; } = null!;
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }
    [Parameter]
    public List<ChatMessageDto>? Messages { get; set; }
    [Parameter]
    public bool Disabled { get; set; } = true;
    [Parameter]
    public EventCallback CloseChat { get; set; }

    private ElementReference _messageListWrapper;
    private List<ChatMessageDto> _messages = [];
    private List<ChatUserDto> _chatMembers = [];
    private string _message = string.Empty;
    private string _inviteEmail = string.Empty;
    private string _inviteStatus = string.Empty;
    private bool _isOwner => User.Id == ChatDto.ChatOwnerId;

    protected override async Task OnInitializedAsync()
    {
        if (ChatHubConnection is not null)
        {
            ChatHubConnection.On<ChatUserDto>("MemberJoined", (ChatUserDto user) => {
                _chatMembers.Add(user);
                InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<ChatDto, ChatUserDto>("MemberRemoved", (ChatDto chat, ChatUserDto chatUser) => {
                _chatMembers.Remove(chatUser);
                InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<ChatUserDto[]>("RetrievedUsers", (ChatUserDto[] users) => {
                _chatMembers = users.ToList();
                InvokeAsync(StateHasChanged);
            });

            await ChatHubConnection.SendAsync("ConnectToChatGroup", ChatDto.Id);
            await ChatHubConnection.SendAsync("GetChatMembers", ChatDto.Id);
        }

        if (MessageHubConnection is not null)
        {
            @* // User comes online
            MessageHubConnection.On<ChatUserDto>("UserJoined", (ChatUserDto user) => {
            });

            // User goes offline
            MessageHubConnection.On<ChatUserDto>("UserLeft", (ChatUserDto user) => {
            });

            MessageHubConnection.On<ChatUserDto>("MemberRemoved", (ChatUserDto user) => {
            }); *@

            MessageHubConnection.On<ChatMessageDto>("ReceiveMessage", (ChatMessageDto message) =>
            {
                _messages.Add(message);
                InvokeAsync(StateHasChanged);
            });

            MessageHubConnection.On<ChatMessageDto[]>("RetrievedMessages", (ChatMessageDto[] messages) =>
            {
                _messages = messages.ToList();
                InvokeAsync(StateHasChanged);
            });

            await MessageHubConnection.SendAsync("JoinChat", ChatDto.Id, User.Id);
            await MessageHubConnection.SendAsync("GetChatHistory", ChatDto.Id);

        }
    }

    private async Task ScrollToBottom()
    {
        if (_messageListWrapper.Id != null)
        {
            await JSRuntime.InvokeVoidAsync("scrollToElementBottom", _messageListWrapper);
        }
    }

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(_message) || User == null)
            return;

        ChatMessageDto newMessage = new()
        {
            ChatId = ChatDto.Id,
            ChatUserId = User.Id,
            SenderEmail = User.Email ?? string.Empty,
            MessageContent = _message,
            MessageDateTime = DateTime.UtcNow
        };

        Console.WriteLine($"{newMessage.SenderEmail}");

        try
        {
            if (MessageHubConnection is not null)
            {
                await MessageHubConnection.SendAsync("SendMessage", ChatDto.Id, newMessage);
                await ScrollToBottom();
            }
            _message = string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
    }

    /// <summary>
    /// Invite a user to the chat by email.
    /// Calls ChatHub to create the invitation.
    /// </summary>
    private async Task InviteMember()
    {
        if (string.IsNullOrWhiteSpace(_inviteEmail) || ChatHubConnection is null)
        {
            _inviteStatus = "Please enter a valid email address";
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("InviteUserToChat", ChatDto.Id, User.Id, _inviteEmail);
        }
        catch (Exception ex)
        {
            _inviteStatus = $"Error: {ex.Message}";
            Console.WriteLine($"Error inviting member: {ex.Message}");
        }
    }

    /// <summary>
    /// Remove a member from the chat.
    /// Only the chat owner can remove members.
    /// Calls ChatHub to remove the user.
    /// </summary>
    private async Task RemoveMember(int memberId)
    {
        if (ChatHubConnection is null)
        {
            Console.WriteLine("ChatHub connection not available");
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("RemoveUserFromChat", ChatDto.Id, User.Id, memberId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing member: {ex.Message}");
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (ChatHubConnection is not null)
        {
            await ChatHubConnection.SendAsync("DisconnectToChatGroup", ChatDto.Id);
        }
        if (MessageHubConnection is not null)
        {
            await MessageHubConnection.SendAsync("LeaveChat", ChatDto.Id, User.Id);
        }
    }
}
