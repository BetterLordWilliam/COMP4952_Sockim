@using COMP4952_Sockim.Hubs
@using COMP4952_Sockim.Models
@using COMP4952_Sockim.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Claims

@implements IAsyncDisposable


<div style="margin-right: auto;">
    <button class="btn-remove" @onclick="ToggleModal">Show Invitations (@Invitations.Count)</button>
    @if (_showModal)
    {
        <div class="modal">
            <div class="modal-content invitation-modal-content">
                <h3>Invitations</h3>
                @if (User is not null && Invitations.Count > 0)
                {
                    @foreach(ChatInvitationDto invitation in Invitations)
                    {
                        <div class="invitation-item">
                            <span class="invitation-meta"><b>@invitation.ChatName</b> - invited by @invitation.SenderEmail</span>
                            <button type="button" class="btn-accept" @onclick="() => AcceptInvitation(invitation)" title="Accept invitation">Accept</button>
                            <button type="button" class="btn-reject" @onclick="() => RejectInvitation(invitation)" title="Reject invitation">Reject</button>
                        </div>
                    }
                }
                else
                {
                    <p>No pending invitations</p>
                }
                <button class="btn-remove" @onclick="ToggleModal">Close</button>
            </div>
        </div>
    }
</div>

@code {
    private bool _showModal = false;
    private void ToggleModal() => _showModal = !_showModal;
}

@code {
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }
    [Parameter]
    public ChatUser? User { get; set; }
    [Parameter]
    public List<ChatInvitationDto> Invitations { get; set; } = [];

    /// <summary>
    /// Accepts an invitation and removes it from the pending list.
    /// Calls InvitationHub.AcceptInvitation which will orchestrate adding user to chat.
    /// </summary>
    /// <summary>
    /// Accepts an invitation and sends it to ChatHub for processing.
    /// </summary>
    private async Task AcceptInvitation(ChatInvitationDto invitationDto)
    {
        if (ChatHubConnection is not null && invitationDto is not null)
        {
            try
            {
                await ChatHubConnection.SendAsync("AcceptInvitation", invitationDto);
                Invitations.Remove(invitationDto);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting invitation: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Rejects an invitation and sends it to ChatHub for processing.
    /// </summary>
    private async Task RejectInvitation(ChatInvitationDto invitationDto)
    {
        if (ChatHubConnection is not null && invitationDto is not null)
        {
            try
            {
                await ChatHubConnection.SendAsync(
                    "RejectInvitation",
                    invitationDto.SenderId,
                    invitationDto.ReceiverId,
                    invitationDto.ChatId);
                Invitations.Remove(invitationDto);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception)
            {
                Console.WriteLine($"Error rejecting invitation");
            }
        }
    }

    public ValueTask DisposeAsync()
    {
        return ValueTask.CompletedTask;
    }
}
