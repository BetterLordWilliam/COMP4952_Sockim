@using COMP4952_Sockim.Hubs
@using COMP4952_Sockim.Models
@using COMP4952_Sockim.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using System.Security.Claims

@implements IAsyncDisposable

@if(User is not null && InvitationHubConnection is not null)
{
    @foreach(ChatInvitationDto invitation in Invitations)
    {
        <div class="invitation-item">
            <span><b>@invitation.ChatName</b> - invited by @invitation.SenderEmail</span>
            <button type="button" class="btn-accept" @onclick="() => AcceptInvitation(invitation)" title="Accept invitation">O</button>
            <button type="button" class="btn-reject" @onclick="() => RejectInvitation(invitation)" title="Reject invitation">X</button>
        </div>
    }
    @if (Invitations.Count == 0)
    {
        <p><em>No pending invitations</em></p>
    }
}

@code {
    [Parameter]
    public HubConnection? InvitationHubConnection { get; set; }
    [Parameter]
    public ChatUser? User { get; set; }
    [Parameter]
    public List<ChatInvitationDto> Invitations { get; set; } = [];

    /// <summary>
    /// Accepts an invitation and removes it from the pending list.
    /// Calls InvitationHub.AcceptInvitation which will orchestrate adding user to chat.
    /// </summary>
    private async Task AcceptInvitation(ChatInvitationDto invitationDto)
    {
        if (InvitationHubConnection is not null && invitationDto is not null)
        {
            try
            {
                invitationDto.Accepted = true;
                await InvitationHubConnection.SendAsync("AcceptInvitation", invitationDto);
                // Remove from UI list immediately for better UX
                Invitations.Remove(invitationDto);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error accepting invitation: {ex.Message}");
            }
        }
    }

    /// <summary>
    /// Rejects an invitation and removes it from the pending list.
    /// Calls InvitationHub.RejectInvitation to delete the invitation.
    /// </summary>
    private async Task RejectInvitation(ChatInvitationDto invitationDto)
    {
        if (InvitationHubConnection is not null && invitationDto is not null)
        {
            try
            {
                await InvitationHubConnection.SendAsync(
                    "RejectInvitation",
                    invitationDto.SenderId,
                    invitationDto.ReceiverId,
                    invitationDto.ChatId);
                
                // Remove from UI list immediately for better UX
                Invitations.Remove(invitationDto);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error rejecting invitation: {ex.Message}");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Cleanup if needed
    }
}
