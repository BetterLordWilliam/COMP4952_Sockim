@using COMP4952_Sockim.Components.Account.Pages.Manage
@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Models
@using Microsoft.AspNetCore.SignalR.Client

<div class="modal">
    <div class="modal-content members-panel">
        @if (_editChatName)
        {
            <div class="">
                <div class="rename-chat-controls">
                    <h3><input type="text" @bind-value="@_updatedChatName" /></h3>
                    <div class="rename-chat-options">
                        <button class="btn-regular" type="button" @onclick="SaveRenameChat">Save</button>
                        <button class="btn-danger" type="button" @onclick="CancelRenameChat">Cancel</button>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="rename-chat-controls">
                <h3 class="chat-name">@ChatDto?.ChatName</h3>
                <button class="btn-regular rename-button" type="button" @onclick="@RenameChat">Rename</button>
            </div>
        }
        <hr />
        <h3>Chat Members</h3>
        <div class="">
            <div class="invite-controls">
                <input class="invite-email-input" type="email" @bind="_inviteEmail"
                    placeholder="Enter email address of new member" />
                <button type="button" class="btn-regular invite-button" @onclick="InviteMember">Invite</button>
            </div>
            @if (!string.IsNullOrEmpty(_inviteStatus))
            {
                <p class="invite-status">@_inviteStatus</p>
            }
        </div>
        @if (User is not null && ChatMembers is not null && ChatDto is not null && ChatMembers.Count > 0)
        {
            <ul class="members-list">
                @foreach (var member in ChatMembers)
                {
                    <li class="member-item">
                        <span class="member-email">@member.Email</span>
                        @if (member.Id != User.Id)
                        {
                            <button type="button" class="btn-danger" @onclick="() => RemoveMember(member.Id)"
                                title="Remove member">Remove</button>
                        }
                    </li>
                }
            </ul>
        }

        <hr />
        <h3>Message Colors</h3>
        <div class="color-settings">
            <p>Customize message bubble colors for each member:</p>

            @if (ChatMembers is not null)
            {
                @foreach (var member in ChatMembers)
                {
                    <div class="member-color-setting">
                        <span class="member-name">@member.Email</span>
                        <input type="color" value="@GetMemberColor(member.Id)"
                            @onchange="e => UpdateMemberColor(member.Id, e.Value?.ToString())"
                            title="Choose color for @member.Email's messages" />
                        @if (member.Id == User?.Id)
                        {
                            <span class="color-label">(Your messages)</span>
                        }
                    </div>
                }
            }
        </div>
        <button class="btn-danger" type="button" @onclick="() => RemoveMember(User?.Id ?? 0)"
            disabled="@(User == null || _isOwner)">Leave Chat</button>
        <button class="btn-danger" type="button" @onclick="@CloseChatOptions">Close</button>
    </div>
</div>

@code {
    [Parameter]
    public List<ChatUserDto>? ChatMembers { get; set; }
    [Parameter]
    public ChatDto? ChatDto { get; set; }
    [Parameter]
    public ChatUser? User { get; set; }
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }
    [Parameter]
    public EventCallback CloseChatOptions { get; set; }
    [Parameter]
    public Dictionary<int, string>? MemberColors { get; set; }

    private bool _isOwner => User?.Id == ChatDto?.ChatOwnerId;
    private bool _editChatName = false;
    private string _inviteEmail = string.Empty;
    private string _inviteStatus = string.Empty;
    private string _updatedChatName = string.Empty;

    protected override void OnInitialized()
    {
        if (MemberColors != null && ChatMembers != null)
        {
            foreach (var member in ChatMembers)
            {
                MemberColors.TryAdd(member.Id, "#636CCB");
            }
        }
    }

    private string GetMemberColor(int memberId)
    {
        return MemberColors?.TryGetValue(memberId, out string? color) == true ? color : "#636CCB";
    }

    private async Task UpdateMemberColor(int memberId, string? newColor)
    {
        if (string.IsNullOrEmpty(newColor) || MemberColors == null)
        {
            return;
        }

        MemberColors[memberId] = newColor;
        await InvokeAsync(StateHasChanged);
    }

    private void RenameChat()
    {
        _editChatName = true;
        _updatedChatName = ChatDto?.ChatName ?? string.Empty;

        InvokeAsync(StateHasChanged);
    }

    private async void SaveRenameChat()
    {
        _editChatName = false;

        if (ChatHubConnection is null || ChatDto is null)
            return;

        ChatDto.ChatName = _updatedChatName;

        await ChatHubConnection.SendAsync("RenameChat", ChatDto);
        await InvokeAsync(StateHasChanged);
    }

    private void CancelRenameChat()
    {
        _editChatName = false;

        InvokeAsync(StateHasChanged);
    }

    /// <summary>
    /// Invite a user to the chat by email.
    /// Calls ChatHub to create the invitation.
    /// </summary>
    private async Task InviteMember()
    {
        if (string.IsNullOrWhiteSpace(_inviteEmail) || ChatHubConnection is null)
        {
            _inviteStatus = "Please enter a valid email address";
            return;
        }

        if (ChatDto is null || User is null)
        {
            Console.WriteLine("Invalid state");
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("InviteUserToChat", ChatDto.Id, User.Id, _inviteEmail);
        }
        catch (Exception ex)
        {
            _inviteStatus = $"Error: {ex.Message}";
            Console.WriteLine($"Error inviting member: {ex.Message}");
        }
    }

    /// <summary>
    /// Remove a member from the chat.
    /// Only the chat owner can remove members.
    /// Calls ChatHub to remove the user.
    /// </summary>
    private async Task RemoveMember(int memberId)
    {
        if (ChatHubConnection is null)
        {
            Console.WriteLine("ChatHub connection not available");
            return;
        }

        if (ChatDto is null || User is null)
        {
            Console.WriteLine("Invalid state");
            return;
        }

        try
        {
            await ChatHubConnection.SendAsync("RemoveUserFromChat", ChatDto.Id, User.Id, memberId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error removing member: {ex.Message}");
        }
    }
}