@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Components.Chat
@using COMP4952_Sockim.Services
@using COMP4952_Sockim.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.IdentityModel.Tokens
@using System.Security.Claims

@rendermode InteractiveServer
@inject UserManager<ChatUser> UserManager
@inject AuthenticationStateProvider ASP
@inject ChatUserService ChatUserService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime


<div class="modal">
    <div class="modal-content input-controls">
        <h3>Create a New Chat</h3>
        <form @onsubmit="OnChatCreateSubmit">
            <label for="chat-name">Chat name:</label>
            <br />
            <input  id="chat-name"
                    class="input-full-width"
                    type="text"
                    placeholder="Specify chat name"
                    @bind-value="_chatName" />
            @* <label for="user-emails">User emails (space separated):</label>
            @if(_isBadEmail)
            {
                <div class="error-message">
                    @_badEmailMessage: @_badEmail
                </div>
            }
            <div class="email-list">
                @{
                    int i = 0;
                    foreach (var email in _emails)
                    {
                        if (i == 0) { <span>@email</span> } else { <span>, @email</span> }
                        <button type="button" class="btn-remove" @onclick="() => RemoveEmail(email)" title="Remove email">Remove</button>
                        i++;
                    }
                }
            </div>
            <input  id="user-emails"
                    class="input-full-width"
                    type="text"
                    placeholder="Add user email"
                    @bind-value=_newEmail
                    @bind-value:event="oninput"
                    @onkeydown="AddEmail" /> *@
            <button class="btn-regular" type="submit">Create</button>
            <button class="btn-reject" type="button" @onclick="OnClose">Close</button>
        </form>
    </div>
</div>

@code {
    [Parameter]
    public EventCallback OnClose { get; set; }
    [Parameter]
    public ChatUser User { get; set; } = null!;
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }

    private string _chatName { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        if (ChatHubConnection is not null)
        {
            ChatHubConnection.On<ChatDto>("ChatCreated", async (chatDto) =>
            {
                ResetForm();
                await InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<object>("Error", async (error) =>
            {
                // Handle error
                Console.WriteLine($"Error from server: {error}");
                await InvokeAsync(StateHasChanged);
            });

            if (ChatHubConnection.State == HubConnectionState.Disconnected)
                await ChatHubConnection.StartAsync();
        }
    }

    private async Task OnChatCreateSubmit() 
    {
        ChatDto chatDto = new()
        {
            ChatName = _chatName,
            ChatOwnerId = User.Id,
        };

        if (ChatHubConnection is not null)
        {
            try
            {
                await ChatHubConnection.SendAsync("AddChat", chatDto);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error sending to hub: {ex.Message}");
            }
        }
    }

    private void ResetForm()
    {
        _chatName = string.Empty;
    }
}
