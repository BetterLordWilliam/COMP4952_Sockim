@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Components.Chat
@using COMP4952_Sockim.Services
@using COMP4952_Sockim.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.IdentityModel.Tokens
@using System.Security.Claims

@rendermode InteractiveServer
@implements IAsyncDisposable
@inject UserManager<ChatUser> UserManager
@inject AuthenticationStateProvider ASP
@inject ChatUserService ChatUserService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<h3>ChatCreateForm</h3>

<form @onsubmit="OnChatCreateSubmit">
    <label>
        Chat name:
        <input type="text" @bind-value="_chatName"></input>
    </label>
    <br />
    <label>
        User emails (space seperated):
        @if(_isBadEmail)
        {
            <div>
                @_badEmailMessage: @_badEmail
            </div>
        }
        <div>
            @{
                int i = 0;
                foreach (var email in _emails)
                {
                    if (i == 0) { <span>@email</span> } else { <span>, @email</span> }
                    <button type="button" @onclick="() => RemoveEmail(email)">X</button>
                    i++;
                }
            }
        </div>
        <input  type="text"
                placeholder=""
                @bind-value=_newEmail
                @bind-value:event="oninput"
                @onkeydown="AddEmail" />
    </label>
    <br />
    <button type="submit" disabled="@(!IsConnected)">
        Submit
    </button>
</form>

@code {
    [Parameter]
    public EventCallback OnFormSubmit { get; set; }

    private ChatUser? _user;
    private AuthenticationState? _authState;
    private ClaimsPrincipal? _claimsPrincipal;
    private HubConnection? _hubConnection;

    private string _chatName { get; set; } = string.Empty;
    private List<string> _emails { get; set; } = new ();
    private string _newEmail { get; set; } = string.Empty;

    private string _badEmail { get; set; } = string.Empty;
    private string _badEmailMessage { get; set; } = string.Empty;
    private bool _isBadEmail = false;

    public bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    protected override async Task OnInitializedAsync()
    {
        _authState = await ASP.GetAuthenticationStateAsync();
        _claimsPrincipal = _authState.User;
        if (_authState.User.Identity!.IsAuthenticated)
        {
            _user = (await UserManager.GetUserAsync(_claimsPrincipal))!;
        }

        // Initialize SignalR connection
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(NavManager.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<ChatDto>("ChatCreated", async (chatDto) =>
        {
            // Chat was created successfully
            if (OnFormSubmit.HasDelegate)
            {
                await OnFormSubmit.InvokeAsync();
            }
            ResetForm();
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<object>("Error", async (error) =>
        {
            // Handle error
            Console.WriteLine($"Error from server: {error}");
            await InvokeAsync(StateHasChanged);
        });

        try
        {
            await _hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error connecting to hub: {ex.Message}");
        }
    }

    private async Task OnChatCreateSubmit() 
    {
        if (string.IsNullOrWhiteSpace(_chatName))
        {
            _badEmailMessage = "Chat name is required";
            _isBadEmail = true;
            return;
        }

        if (_user == null)
        {
            _badEmailMessage = "User not authenticated";
            _isBadEmail = true;
            return;
        }

        // Create chat DTO
        ChatDto chatDto = new()
        {
            ChatName = _chatName,
            ChatOwnerId = _user.Id,
            InvitedEmails = new List<string>(_emails)
        };

        // Create invitation DTOs
        List<ChatInvitationDto> invitations = new();
        ChatUser[]? invitedUsers = ChatUserService.GetUserByEmail(_emails.ToArray());

        if (invitedUsers != null)
        {
            foreach (ChatUser invitedUser in invitedUsers)
            {
                invitations.Add(new ChatInvitationDto
                {
                    SenderId = _user.Id,
                    SenderEmail = _user.Email ?? string.Empty,
                    ReceiverId = invitedUser.Id,
                    ReceiverEmail = invitedUser.Email ?? string.Empty,
                    Accepted = false
                });
            }
        }

        // Send to hub
        if (_hubConnection != null && IsConnected)
        {
            try
            {
                await _hubConnection.SendAsync("AddChat", chatDto, invitations);
            }
            catch (Exception ex)
            {
                _badEmailMessage = "Error creating chat";
                _isBadEmail = true;
                Console.WriteLine($"Error sending to hub: {ex.Message}");
            }
        }
    }

    private void AddEmail(KeyboardEventArgs e)
    {
        bool checkKey = e.Key == " ";

        if(checkKey && !_newEmail.IsNullOrEmpty() && !_emails.Contains(_newEmail))
        {
            if (_newEmail == _user?.Email)
            {
                _badEmail = _newEmail;
                _isBadEmail = true;
                _badEmailMessage = "cannot invite yourself to a group";

                return;
            }

            bool userHasEmail = ChatUserService.GetUserByEmail(_newEmail) is not null;

            if (!userHasEmail)
            {
                _badEmail = _newEmail;
                _isBadEmail = true;
                _badEmailMessage = "no such user";

                return;
            }

            _emails.Add(_newEmail);
            _newEmail = string.Empty;
            _isBadEmail = false;

            return;
        }

        bool delete = e.Key == "Backspace";

        @* Console.WriteLine(_newEmail); *@

        if (delete && !_isBadEmail && _newEmail.Length > 0 && _newEmail[^1] == ' ' && _emails.Count() > 0)
        {
            RemoveEmail(_emails[_emails.Count() - 1]);
            _newEmail = string.Empty;
            _isBadEmail = false;
            return;
        }
    }

    private void RemoveEmail(string email)
    {
        if (_emails.Contains(email))
        {
            _emails.Remove(email);
        }
    }

    private void ResetForm()
    {
        _chatName = string.Empty;
        _emails.Clear();
        _newEmail = string.Empty;
        _isBadEmail = false;
        _badEmail = string.Empty;
        _badEmailMessage = string.Empty;
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
