@using COMP4952_Sockim.Data
@using COMP4952_Sockim.Components.Chat
@using COMP4952_Sockim.Services
@using COMP4952_Sockim.Models
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.IdentityModel.Tokens
@using System.Security.Claims

@rendermode InteractiveServer
@inject UserManager<ChatUser> UserManager
@inject AuthenticationStateProvider ASP
@inject ChatUserService ChatUserService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime

<h3>ChatCreateForm</h3>

<form @onsubmit="OnChatCreateSubmit">
    <label>
        Chat name:
        <input type="text" @bind-value="_chatName"></input>
    </label>
    <br />
    <label>
        User emails (space seperated):
        @if(_isBadEmail)
        {
            <div>
                @_badEmailMessage: @_badEmail
            </div>
        }
        <div>
            @{
                int i = 0;
                foreach (var email in _emails)
                {
                    if (i == 0) { <span>@email</span> } else { <span>, @email</span> }
                    <button type="button" @onclick="() => RemoveEmail(email)">X</button>
                    i++;
                }
            }
        </div>
        <input  type="text"
                placeholder=""
                @bind-value=_newEmail
                @bind-value:event="oninput"
                @onkeydown="AddEmail" />
    </label>
    <br />
    <button type="submit">
        Submit
    </button>
</form>

@code {
    [Parameter]
    public ChatUser User { get; set; } = null!;
    [Parameter]
    public HubConnection? ChatHubConnection { get; set; }

    private string _chatName { get; set; } = string.Empty;
    private List<string> _emails { get; set; } = new ();
    private string _newEmail { get; set; } = string.Empty;
    private string _badEmail { get; set; } = string.Empty;
    private string _badEmailMessage { get; set; } = string.Empty;
    private bool _isBadEmail = false;

    protected override async Task OnInitializedAsync()
    {
        if (ChatHubConnection is not null)
        {
            ChatHubConnection.On<ChatDto>("ChatCreated", async (chatDto) =>
            {
                ResetForm();
                await InvokeAsync(StateHasChanged);
            });

            ChatHubConnection.On<object>("Error", async (error) =>
            {
                // Handle error
                Console.WriteLine($"Error from server: {error}");
                await InvokeAsync(StateHasChanged);
            });

            if (ChatHubConnection.State == HubConnectionState.Disconnected)
                await ChatHubConnection.StartAsync();
        }
    }

    private async Task OnChatCreateSubmit() 
    {
        if (string.IsNullOrWhiteSpace(_chatName))
        {
            _badEmailMessage = "Chat name is required";
            _isBadEmail = true;
            return;
        }

        if (User == null)
        {
            _badEmailMessage = "User not authenticated";
            _isBadEmail = true;
            return;
        }

        ChatDto chatDto = new()
        {
            ChatName = _chatName,
            ChatOwnerId = User.Id,
            InvitedEmails = new List<string>(_emails)
        };

        List<ChatInvitationDto> invitations = new();
        ChatUser[]? invitedUsers = ChatUserService.GetUserByEmail(_emails.ToArray());

        if (invitedUsers != null)
        {
            foreach (ChatUser invitedUser in invitedUsers)
            {
                invitations.Add(new ChatInvitationDto
                {
                    ChatName = _chatName,
                    SenderId = User.Id,
                    SenderEmail = User.Email ?? string.Empty,
                    ReceiverId = invitedUser.Id,
                    ReceiverEmail = invitedUser.Email ?? string.Empty,
                    Accepted = false
                });
            }
        }

        if (ChatHubConnection is not null)
        {
            try
            {
                await ChatHubConnection.SendAsync("AddChat", chatDto, invitations);
            }
            catch (Exception ex)
            {
                _badEmailMessage = "Error creating chat";
                _isBadEmail = true;
                Console.WriteLine($"Error sending to hub: {ex.Message}");
            }
        }
    }

    private void AddEmail(KeyboardEventArgs e)
    {
        bool checkKey = e.Key == " ";

        if(checkKey && !_newEmail.IsNullOrEmpty() && !_emails.Contains(_newEmail))
        {
            if (_newEmail == User?.Email)
            {
                _badEmail = _newEmail;
                _isBadEmail = true;
                _badEmailMessage = "cannot invite yourself to a group";

                return;
            }

            bool userHasEmail = ChatUserService.GetUserByEmail(_newEmail) is not null;

            if (!userHasEmail)
            {
                _badEmail = _newEmail;
                _isBadEmail = true;
                _badEmailMessage = "no such user";

                return;
            }

            _emails.Add(_newEmail);
            _newEmail = string.Empty;
            _isBadEmail = false;

            return;
        }

        bool delete = e.Key == "Backspace";

        @* Console.WriteLine(_newEmail); *@

        if (delete && !_isBadEmail && _newEmail.Length > 0 && _newEmail[^1] == ' ' && _emails.Count() > 0)
        {
            RemoveEmail(_emails[_emails.Count() - 1]);
            _newEmail = string.Empty;
            _isBadEmail = false;
            return;
        }
    }

    private void RemoveEmail(string email)
    {
        if (_emails.Contains(email))
        {
            _emails.Remove(email);
        }
    }

    private void ResetForm()
    {
        _chatName = string.Empty;
        _emails.Clear();
        _newEmail = string.Empty;
        _isBadEmail = false;
        _badEmail = string.Empty;
        _badEmailMessage = string.Empty;
    }
}
